<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>E-BOOK Viewer (PDF.js + PageFlip)</title>

  <!-- PageFlip CSS (MIT ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.css">

  <style>
    :root {
      --bg: #0b1020;
      --panel: #12182c;
      --txt: #e7ecff;
      --muted: #9fb0ff;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--txt); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; }
    .wrap { display:flex; flex-direction:column; height:100%; }
    header {
      display:flex; align-items:center; gap:.75rem;
      padding:.75rem 1rem; background:linear-gradient(180deg, #141b33, #0f1530);
      position: sticky; top:0; z-index:10; box-shadow: 0 2px 18px rgba(0,0,0,.3);
    }
    header .brand { font-weight:700; letter-spacing:.3px; }
    header .muted { color: var(--muted); font-size:.9rem; }
    .controls { display:flex; align-items:center; gap:.5rem; margin-left:auto; }
    .btn {
      background:#1b2444; border:1px solid #2b3866; color:#fff;
      padding:.45rem .7rem; border-radius:.6rem; cursor:pointer; font-weight:600;
      transition:.15s ease; user-select:none;
    }
    .btn:hover { background:#223060; border-color:#3e5191; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .counter { min-width:90px; text-align:center; font-variant-numeric: tabular-nums; }

    /* ë·°ì–´ ì˜ì—­ */
    .stage {
      display:flex; justify-content:center; align-items:center;
      flex:1 1 auto; min-height:0; padding:1rem; overflow:auto;
    }
    #flipbook {
      width:min(92vw, 1200px);
      height:clamp(360px, 75vh, 900px);
      background:#0d1530; border:1px solid #2b3866; border-radius:16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45), inset 0 0 60px rgba(48,74,145,.15);
    }
    /* í˜ì´ì§€ ë‚´ë¶€ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .page {
      display:flex; width:100%; height:100%; background:#111935;
      box-shadow: inset 0 0 40px rgba(0,0,0,.25);
    }
    .page img {
      width:100%; height:100%; object-fit:contain; display:block; image-rendering:auto;
      filter: drop-shadow(0 6px 24px rgba(0,0,0,.35));
    }

    footer {
      padding:.8rem 1rem; text-align:center; color:#8ba1ff; font-size:.85rem; background:transparent;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">ğŸ“– E-BOOK ë·°ì–´</div>
    <div class="muted">PDF.js + PageFlip</div>
    <div class="controls">
      <button id="btnPrev" class="btn" aria-label="ì´ì „ í˜ì´ì§€">â† Prev</button>
      <div id="pageCounter" class="counter">0 / 0</div>
      <button id="btnNext" class="btn" aria-label="ë‹¤ìŒ í˜ì´ì§€">Next â†’</button>
      <button id="btnZoomOut" class="btn" title="Zoom Out">â€“</button>
      <button id="btnZoomIn" class="btn" title="Zoom In">+</button>
      <button id="btnFullscreen" class="btn" title="ì „ì²´í™”ë©´">â¤¢</button>
    </div>
  </header>

  <main class="stage">
    <!-- PageFlip ì»¨í…Œì´ë„ˆ -->
    <div id="flipbook"></div>
  </main>

  <footer>
    ì„±ëŠ¥ íŒ: í° PDFëŠ” ì²« 6~8í˜ì´ì§€ë§Œ ì„ ë Œë”ë§ í›„ ìŠ¤í¬ë¡¤/ë„˜ê¹€ ì‹œ ì§€ì—° ë Œë”ë§ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
  </footer>
</div>

<!-- PDF.js (Core/Worker) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  // PDF.js ì›Œì»¤ ê²½ë¡œ ì§€ì •(í•„ìˆ˜)
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<!-- PageFlip (ë°”ë‹ë¼ JS ë²„ì „) -->
<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>

<script>
(async function () {
  // 1) ì„¤ì •
  const PDF_URL = "assets/book.pdf";     // â† ì—¬ê¸°ì— ë‹¹ì‹ ì˜ PDF ê²½ë¡œ
  const INITIAL_SCALE = 2.0;             // ë Œë”ë§ í•´ìƒë„ (2.0~2.5 ê¶Œì¥)
  const PREFETCH_PAGES = 8;              // ì´ˆê¸° ì„ ë Œë”ë§ í˜ì´ì§€ ìˆ˜
  const MAX_CANVAS_DIM = 2560;           // ê³ í•´ìƒë„ ê¸°ê¸°ì—ì„œ ìº”ë²„ìŠ¤ ìµœëŒ€ í•œ ë³€ ì œí•œ (ì„±ëŠ¥/ë©”ëª¨ë¦¬ ë³´í˜¸)

  // 2) DOM ì°¸ì¡°
  const flipEl = document.getElementById("flipbook");
  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");
  const btnZoomIn = document.getElementById("btnZoomIn");
  const btnZoomOut = document.getElementById("btnZoomOut");
  const btnFullscreen = document.getElementById("btnFullscreen");
  const pageCounter = document.getElementById("pageCounter");

  // 3) PageFlip ì´ˆê¸°í™”
  const pageFlip = new St.PageFlip(flipEl, {
    width: 700,            // ê¸°ì¤€ í­
    height: 900,           // ê¸°ì¤€ ë†’ì´ (ì¢…íš¡ë¹„ë§Œ ëŒ€ëµ ìœ ì§€í•˜ë©´ OK)
    size: "stretch",       // ì»¨í…Œì´ë„ˆì— ë§ì¶° ë°˜ì‘í˜•
    minWidth: 315,
    minHeight: 420,
    maxShadowOpacity: 0.35,
    showCover: false,      // trueë©´ 1í˜ì´ì§€ë¥¼ í‘œì§€ì²˜ëŸ¼ ë‹¨ë©´ ì²˜ë¦¬
    mobileScrollSupport: true,
    usePortrait: true,     // ì„¸ë¡œ ë‹¨ë©´ ëª¨ë“œ ìë™ ì „í™˜
    disableFlipByClick: false,
    swipeDistance: 30,
  });

  // 4) PDF ë¡œë“œ
  const pdf = await pdfjsLib.getDocument(PDF_URL).promise;
  const total = pdf.numPages;

  // í˜ì´ì§€ ìƒíƒœ
  let currentScale = INITIAL_SCALE;
  let rendered = new Array(total).fill(false);
  let pageBitmaps = new Array(total).fill(null);

  // 5) ìœ í‹¸: í˜ì´ì§€ ë Œë”ë§ â†’ dataURL ë°˜í™˜
  async function renderPageToDataURL(pageNumber, scale = currentScale) {
    const page = await pdf.getPage(pageNumber);
    const viewport0 = page.getViewport({ scale: 1.0 });

    // ìµœëŒ€ í•´ìƒë„ ì œí•œ ì ìš©
    const autoScale = Math.min(
      scale,
      MAX_CANVAS_DIM / Math.max(viewport0.width, viewport0.height)
    );
    const viewport = page.getViewport({ scale: autoScale });

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: false, alpha: false });
    canvas.width = Math.floor(viewport.width);
    canvas.height = Math.floor(viewport.height);

    await page.render({ canvasContext: ctx, viewport }).promise;

    const dataURL = canvas.toDataURL("image/jpeg", 0.9);
    canvas.width = canvas.height = 0; // ë©”ëª¨ë¦¬ í•´ì œ íŒíŠ¸
    return dataURL;
  }

  // 6) PageFlipì— í˜ì´ì§€ ì¶”ê°€(ë¹ˆ ê»ë°ê¸° í›„ ì´ë¯¸ì§€ ì±„ìš°ê¸°)
  function addEmptyPages(count) {
    const pages = [];
    for (let i = 0; i < count; i++) {
      const page = document.createElement("div");
      page.className = "page";
      const img = document.createElement("img");
      img.alt = `Page ${i + 1}`;
      img.decoding = "async";
      img.loading = "eager";
      page.appendChild(img);
      pages.push(page);
    }
    pageFlip.loadFromHTML(pages);
  }

  addEmptyPages(total);

  // 7) ì´ˆê¸° ì„ ë Œë”ë§
  async function preRender(start = 1, end = Math.min(PREFETCH_PAGES, total)) {
    for (let p = start; p <= end; p++) {
      if (!rendered[p - 1]) {
        const url = await renderPageToDataURL(p);
        const pageEl = pageFlip.getPage(p - 1).element;
        pageEl.querySelector("img").src = url;
        pageBitmaps[p - 1] = url;
        rendered[p - 1] = true;
      }
    }
  }
  await preRender(1, Math.min(PREFETCH_PAGES, total));
  updateCounter(1, total);

  // 8) í˜ì´ì§€ ì´ë™ ì‹œ ì£¼ë³€ ì§€ì—° ë Œë”ë§
  async function lazyRenderAround(index) {
    const neighbors = [index, index + 1, index - 1, index + 2, index - 2];
    for (const i of neighbors) {
      if (i >= 0 && i < total && !rendered[i]) {
        const url = await renderPageToDataURL(i + 1);
        const pageEl = pageFlip.getPage(i).element;
        pageEl.querySelector("img").src = url;
        pageBitmaps[i] = url;
        rendered[i] = true;
      }
    }
  }

  // 9) ì¹´ìš´í„° UI ì—…ë°ì´íŠ¸
  function updateCounter(page, total) {
    pageCounter.textContent = `${page} / ${total}`;
    btnPrev.disabled = (page <= 1);
    btnNext.disabled = (page >= total);
  }

  // 10) ì´ë²¤íŠ¸ ë°”ì¸ë”©
  pageFlip.on("flip", async (e) => {
    const current = e.data + 1; // 1-based
    updateCounter(current, total);
    lazyRenderAround(e.data);
  });

  // ì´ˆê¸° í˜ì´ì§€ í‘œì‹œ(í•„ìˆ˜)
  pageFlip.flip(0);

  // ë²„íŠ¼ ì»¨íŠ¸ë¡¤
  btnPrev.addEventListener("click", () => pageFlip.flipPrev());
  btnNext.addEventListener("click", () => pageFlip.flipNext());

  // ì¤Œ (ì¬ë Œë”ë§)
  async function rerenderAll(newScale) {
    currentScale = Math.max(1.0, Math.min(newScale, 3.0));
    // ì´ë¯¸ ë Œë”ëœ í˜ì´ì§€ë§Œ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤(ì„±ëŠ¥ ìµœì í™”)
    for (let i = 0; i < total; i++) {
      if (rendered[i]) {
        const url = await renderPageToDataURL(i + 1, currentScale);
        const pageEl = pageFlip.getPage(i).element;
        const img = pageEl.querySelector("img");
        img.src = url;
        pageBitmaps[i] = url;
      }
    }
  }

  btnZoomIn.addEventListener("click", () => rerenderAll(currentScale + 0.25));
  btnZoomOut.addEventListener("click", () => rerenderAll(currentScale - 0.25));

  // ì „ì²´í™”ë©´
  btnFullscreen.addEventListener("click", () => {
    const el = document.documentElement;
    if (!document.fullscreenElement) {
      el.requestFullscreen?.();
    } else {
      document.exitFullscreen?.();
    }
  });

  // ë°˜ì‘í˜•(ì°½ í¬ê¸° ë³€í•  ë•Œ ë ˆì´ì•„ì›ƒ ì¬ê³„ì‚°)
  window.addEventListener("resize", () => pageFlip.update());
})();
</script>
</body>
</html>
